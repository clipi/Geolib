/**
 * A small library to provide some basic geo functions like distance calculation,
 * conversion of decimal coordinates to sexagesimal and vice versa, etc.
 * WGS 84 (World Geodetic System 1984)
 * 
 * @author Manuel Bieh
 * @url http://www.manuelbieh.com/
 * @version 1.1.7
 * @license http://www.gnu.org/licenses/lgpl-3.0.txt LGPL
 *
 */(function(a,b){var c=6378137,d=/^([0-9]{1,3})°\s*([0-9]{1,3})'\s*(([0-9]{1,3}(\.([0-9]{1,2}))?)"\s*)?([NEOSW]?)$/,e,f;if(typeof a.navigator=="undefined")var g=require("googlemaps");var h={decimal:{},sexagesimal:{},distance:0,getKeys:function(a){var b=a.hasOwnProperty("lat")?"lat":"latitude",c=(a.hasOwnProperty("lng")?"lng":!1)||(a.hasOwnProperty("long")?"long":!1)||"longitude",d=(a.hasOwnProperty("alt")?"alt":!1)||(a.hasOwnProperty("altitude")?"altitude":!1)||(a.hasOwnProperty("elev")?"elev":!1)||"elevation";return{latitude:b,longitude:c,elevation:d}},getDistance:function(a,b,c){var d=h.getKeys(a),e=d.latitude,f=d.longitude,g=d.elevation;c=Math.floor(c)||1;var i={},j={};i[e]=h.useDecimal(a[e]),i[f]=h.useDecimal(a[f]),j[e]=h.useDecimal(b[e]),j[f]=h.useDecimal(b[f]);var k=6378137,l=6356752.314245,m=1/298.257223563,n=(j[f]-i[f]).toRad(),o=Math.atan((1-m)*Math.tan(parseFloat(i[e]).toRad())),p=Math.atan((1-m)*Math.tan(parseFloat(j[e]).toRad())),q=Math.sin(o),r=Math.cos(o),s=Math.sin(p),t=Math.cos(p),u=n,v,w=100;do{var x=Math.sin(u),y=Math.cos(u),z=Math.sqrt(t*x*t*x+(r*s-q*t*y)*(r*s-q*t*y));if(z==0)return h.distance=0;var A=q*s+r*t*y,B=Math.atan2(z,A),C=r*t*x/z,D=1-C*C,E=A-2*q*s/D;isNaN(E)&&(E=0);var F=m/16*D*(4+m*(4-3*D));v=u,u=n+(1-F)*m*C*(B+F*z*(E+F*A*(-1+2*E*E)))}while(Math.abs(u-v)>1e-12&&--w>0);if(w==0)return NaN;var G=D*(k*k-l*l)/(l*l),H=1+G/16384*(4096+G*(-768+G*(320-175*G))),I=G/1024*(256+G*(-128+G*(74-47*G))),J=I*z*(E+I/4*(A*(-1+2*E*E)-I/6*E*(-3+4*z*z)*(-3+4*E*E))),K=l*H*(B-J);K=K.toFixed(3);if(a.hasOwnProperty(g)&&b.hasOwnProperty(g)){var L=Math.abs(a[g]-b[g]);K=Math.sqrt(K*K+L*L)}return h.distance=Math.floor(Math.round(K/c)*c)},getDistanceSimple:function(a,b,d){var e=h.getKeys(a),f=e.latitude,g=e.longitude;d=Math.floor(d)||1;var i={},j={};i[f]=parseFloat(h.useDecimal(a[f])).toRad(),i[g]=parseFloat(h.useDecimal(a[g])).toRad(),j[f]=parseFloat(h.useDecimal(b[f])).toRad(),j[g]=parseFloat(h.useDecimal(b[g])).toRad();var k=Math.round(Math.acos(Math.sin(j[f])*Math.sin(i[f])+Math.cos(j[f])*Math.cos(i[f])*Math.cos(i[g]-j[g]))*c);return h.distance=Math.floor(Math.round(k/d)*d)},getCenter:function(a){if(!a.length)return!1;var b=h.getKeys(a[0]),c=b.latitude,d=b.longitude,e=function(a){return Math.max.apply(Math,a)},f=function(a){return Math.min.apply(Math,a)},g,i,j={lat:[],lng:[]};for(var k in a)j.lat.push(h.useDecimal(a[k][c])),j.lng.push(h.useDecimal(a[k][d]));var l=f(j.lat),m=f(j.lng),n=e(j.lat),o=e(j.lng);g=((l+n)/2).toFixed(6),i=((m+o)/2).toFixed(6);var p=h.convertUnit("km",h.getDistance({lat:l,lng:m},{lat:n,lng:o}));return{latitude:g,longitude:i,distance:p}},getBounds:function(a){if(!a.length)return!1;var b=h.getKeys(a[0]),c=b.latitude,d=b.longitude,e=b.elevation,f=a[0].hasOwnProperty(e),g={maxLat:Infinity*-1,minLat:Infinity,maxLng:Infinity*-1,minLng:Infinity};f&&(g.maxElev=Infinity*-1,g.minElev=Infinity);for(var i=0,j=a.length;i<j;++i)g.maxLat=Math.max(a[i][c],g.maxLat),g.minLat=Math.min(a[i][c],g.minLat),g.maxLng=Math.max(a[i][d],g.maxLng),g.minLng=Math.min(a[i][d],g.minLng),f&&(g.maxElev=Math.max(a[i][e],g.maxElev),g.minElev=Math.min(a[i][e],g.minElev));return g},isPointInside:function(a,b){var c=h.getKeys(a),d=c.latitude,e=c.longitude;for(var f=!1,g=-1,i=b.length,j=i-1;++g<i;j=g)(b[g][e]<=a[e]&&a[e]<b[j][e]||b[j][e]<=a[e]&&a[e]<b[g][e])&&a[d]<(b[j][d]-b[g][d])*(a[e]-b[g][e])/(b[j][e]-b[g][e])+b[g][d]&&(f=!f);return f},isPointInCircle:function(a,b,c){return h.getDistance(a,b)<c},getRhumbLineBearing:function(a,b){var c=h.getKeys(a),d=c.latitude,e=c.longitude,f=h.useDecimal(b[e]).toRad()-h.useDecimal(a[e]).toRad(),g=Math.log(Math.tan(h.useDecimal(b[d]).toRad()/2+Math.PI/4)/Math.tan(h.useDecimal(a[d]).toRad()/2+Math.PI/4));return Math.abs(f)>Math.PI&&(f>0?f=(2*Math.PI-f)*-1:f=2*Math.PI+f),(Math.atan2(f,g).toDeg()+360)%360},getBearing:function(a,b){var c=h.getKeys(a),d=c.latitude,e=c.longitude;b[d]=h.useDecimal(b[d]),b[e]=h.useDecimal(b[e]),a[d]=h.useDecimal(a[d]),a[e]=h.useDecimal(a[e]);var f=(Math.atan2(Math.sin(b[e].toRad()-a[e].toRad())*Math.cos(b[d].toRad()),Math.cos(a[d].toRad())*Math.sin(b[d].toRad())-Math.sin(a[d].toRad())*Math.cos(b[d].toRad())*Math.cos(b[e].toRad()-a[e].toRad())).toDeg()+360)%360;return f},getCompassDirection:function(a,b,c){var d;if(c=="circle")var e=h.getBearing(a,b);else var e=h.getRhumbLineBearing(a,b);switch(Math.round(e/22.5)){case 1:d={exact:"NNE",rough:"N"};break;case 2:d={exact:"NE",rough:"N"};break;case 3:d={exact:"ENE",rough:"E"};break;case 4:d={exact:"E",rough:"E"};break;case 5:d={exact:"ESE",rough:"E"};break;case 6:d={exact:"SE",rough:"E"};break;case 7:d={exact:"SSE",rough:"S"};break;case 8:d={exact:"S",rough:"S"};break;case 9:d={exact:"SSW",rough:"S"};break;case 10:d={exact:"SW",rough:"S"};break;case 11:d={exact:"WSW",rough:"W"};break;case 12:d={exact:"W",rough:"W"};break;case 13:d={exact:"WNW",rough:"W"};break;case 14:d={exact:"NW",rough:"W"};break;case 15:d={exact:"NNW",rough:"N"};break;default:d={exact:"N",rough:"N"}}return d},orderByDistance:function(a,b){var c=h.getKeys(a),d=c.latitude,e=c.longitude,f=[];for(var g in b){var i=h.getDistance(a,b[g]);f.push({key:g,latitude:b[g][d],longitude:b[g][e],distance:i})}return f.sort(function(a,b){return a.distance-b.distance})},findNearest:function(a,b,c){c=c||0;var d=h.orderByDistance(a,b);return d[c]},getPathLength:function(a){var b=0,c;for(var d=0,e=a.length;d<e;++d)c&&(b+=h.getDistance(a[d],c)),c=a[d];return b},setBusinessSpecificParameters:function(a,b){g.config("google-client-id",a),g.config("google-private-key",b)},getElevation:function(){typeof a.navigator!="undefined"?h.getElevationClient.apply(this,arguments):h.getElevationServer.apply(this,arguments)},getElevationClient:function(b,c){try{if(!a.google)return c(new Error("Geolib: Google maps api not loaded"));if(b.length==0)return c(null,null);if(b.length==1)return c(new Error("Geolib: getElevation requires at least 2 points."));var d=[],e=h.getKeys(b[0]),f=e.latitude,g=e.longitude;for(var i=0;i<b.length;i++)d.push(new google.maps.LatLng(h.useDecimal(b[i][f]),h.useDecimal(b[i][g])));var j={path:d,samples:d.length},k=new google.maps.ElevationService;k.getElevationAlongPath(j,function(a,d){h.elevationHandler(a,d,b,e,c)})}catch(l){return c(l)}},getElevationServer:function(a,b){try{if(a.length==0)return b(null,null);if(a.length==1)return b(new Error("Geolib: getElevation requires at least 2 points."));var c=[],d=h.getKeys(a[0]);a[0];var e=d.latitude,f=d.longitude;for(var i=0;i<a.length;i++)c.push(h.useDecimal(a[i][e])+","+h.useDecimal(a[i][f]));g.elevationFromPath(c.join("|"),c.length,function(c,e){h.elevationHandler(e.results,e.status,a,d,b)})}catch(j){return b(j)}},elevationHandler:function(a,b,c,d,e){var f=[],g=d.latitude,h=d.longitude;if(b=="OK"){for(var i=0;i<a.length;i++)f.push({lat:c[i][g],lng:c[i][h],elev:a[i].elevation});e(null,f)}else e(new Error("Geolib: Could not get elevation using Google's API: Status: "+b))},getGrade:function(a,b){var c=h.getKeys(a[0]),d=c.elevation,e=a[a.length-1][d]-a[0][d],f=h.getPathLength(a),g=e/f*100;if(typeof b=="number"){var i=Math.pow(10,b);g=Math.floor(g*i)/i}return g},getTotalElevationGainAndLoss:function(a){var b=h.getKeys(a[0]),c=b.elevation,d=0,e=0;for(var f=0;f<a.length-1;f++){var g=a[f][c]-a[f+1][c];g>0?e+=g:d+=Math.abs(g)}return{gain:d,loss:e}},convertUnit:function(a,b,c){if(b==0||typeof b=="undefined"){if(h.distance==0)return 0;b=h.distance}a=a||"m",c=c||4;switch(a){case"m":return h.round(b,c);case"km":return h.round(b/1e3,c);case"cm":return h.round(b*100,c);case"mm":return h.round(b*1e3,c);case"mi":return h.round(b*(1/1609.344),c);case"sm":return h.round(b*(1/1852.216),c);case"ft":return h.round(b*(100/30.48),c);case"in":return h.round(b*100/2.54,c);case"yd":return h.round(b*(1/.9144),c)}return b},useDecimal:function(a){a=a.toString().replace(/\s*/,"");if(!isNaN(parseFloat(a))&&parseFloat(a).toString()==a)return parseFloat(a);if(h.isSexagesimal(a)==1)return parseFloat(h.sexagesimal2decimal(a));throw new Error("Geolib: Unknown format.")},decimal2sexagesimal:function(a){if(a in h.sexagesimal)return h.sexagesimal[a];var b=a.toString().split("."),c=Math.abs(b[0]),d=("0."+b[1])*60,e=d.toString().split(".");return d=Math.floor(d),e=(("0."+e[1])*60).toFixed(2),h.sexagesimal[a]=c+"° "+d+"' "+e+'"',h.sexagesimal[a]},sexagesimal2decimal:function(a){if(a in h.decimal)return h.decimal[a];var b=new RegExp(d),c=b.exec(a);if(c)var e=parseFloat(c[2]/60),f=parseFloat(c[4]/3600)||0;var g=(parseFloat(c[1])+e+f).toFixed(8);return g=c[7]=="S"||c[7]=="W"?g*-1:g,h.decimal[a]=g,g},isSexagesimal:function(a){return d.test(a)},round:function(a,b){var c=Math.pow(10,b);return Math.round(a*c)/c}};typeof Number.prototype.toRad=="undefined"&&(Number.prototype.toRad=function(){return this*Math.PI/180}),typeof Number.prototype.toDeg=="undefined"&&(Number.prototype.toDeg=function(){return this*180/Math.PI}),typeof a.navigator!="undefined"?a.geolib=h:module.exports=h})(this);